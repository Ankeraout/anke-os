bits 32
section .text

%macro M_DEFINE_EXCEPTION 1
    global isrException%1
    isrException%1:
        push 0 ; No error code
        push %1 ; Interrupt number
        jmp isrCommon
%endmacro

%macro M_DEFINE_EXCEPTION_ERRCODE 1
    global isrException%1
    isrException%1:
        push %1 ; Interrupt number
        jmp isrCommon
%endmacro

%macro M_DEFINE_IRQ 1
    global isrIrq%1
    isrIrq%1:
        push 0 ; No error code
        push %1 ; Interrupt number
        jmp isrCommon
%endmacro

extern irqHandler

section .text
M_DEFINE_EXCEPTION 0
M_DEFINE_EXCEPTION 1
M_DEFINE_EXCEPTION 2
M_DEFINE_EXCEPTION 3
M_DEFINE_EXCEPTION 4
M_DEFINE_EXCEPTION 5
M_DEFINE_EXCEPTION 6
M_DEFINE_EXCEPTION 7
M_DEFINE_EXCEPTION_ERRCODE 8
M_DEFINE_EXCEPTION 9
M_DEFINE_EXCEPTION_ERRCODE 10
M_DEFINE_EXCEPTION_ERRCODE 11
M_DEFINE_EXCEPTION_ERRCODE 12
M_DEFINE_EXCEPTION_ERRCODE 13
M_DEFINE_EXCEPTION_ERRCODE 14
M_DEFINE_EXCEPTION 15
M_DEFINE_EXCEPTION 16
M_DEFINE_EXCEPTION_ERRCODE 17
M_DEFINE_EXCEPTION 18
M_DEFINE_EXCEPTION 19
M_DEFINE_EXCEPTION 20
M_DEFINE_EXCEPTION_ERRCODE 21
M_DEFINE_EXCEPTION 22
M_DEFINE_EXCEPTION 23
M_DEFINE_EXCEPTION 24
M_DEFINE_EXCEPTION 25
M_DEFINE_EXCEPTION 26
M_DEFINE_EXCEPTION 27
M_DEFINE_EXCEPTION 28
M_DEFINE_EXCEPTION_ERRCODE 29
M_DEFINE_EXCEPTION_ERRCODE 30
M_DEFINE_EXCEPTION 31
M_DEFINE_IRQ 32
M_DEFINE_IRQ 33
M_DEFINE_IRQ 34
M_DEFINE_IRQ 35
M_DEFINE_IRQ 36
M_DEFINE_IRQ 37
M_DEFINE_IRQ 38
M_DEFINE_IRQ 39
M_DEFINE_IRQ 40
M_DEFINE_IRQ 41
M_DEFINE_IRQ 42
M_DEFINE_IRQ 43
M_DEFINE_IRQ 44
M_DEFINE_IRQ 45
M_DEFINE_IRQ 46
M_DEFINE_IRQ 47
M_DEFINE_IRQ 48
M_DEFINE_IRQ 49
M_DEFINE_IRQ 50
M_DEFINE_IRQ 51
M_DEFINE_IRQ 52
M_DEFINE_IRQ 53
M_DEFINE_IRQ 54
M_DEFINE_IRQ 55
M_DEFINE_IRQ 56
M_DEFINE_IRQ 57
M_DEFINE_IRQ 58
M_DEFINE_IRQ 59
M_DEFINE_IRQ 60
M_DEFINE_IRQ 61
M_DEFINE_IRQ 62
M_DEFINE_IRQ 63
M_DEFINE_IRQ 64
M_DEFINE_IRQ 65
M_DEFINE_IRQ 66
M_DEFINE_IRQ 67
M_DEFINE_IRQ 68
M_DEFINE_IRQ 69
M_DEFINE_IRQ 70
M_DEFINE_IRQ 71
M_DEFINE_IRQ 72
M_DEFINE_IRQ 73
M_DEFINE_IRQ 74
M_DEFINE_IRQ 75
M_DEFINE_IRQ 76
M_DEFINE_IRQ 77
M_DEFINE_IRQ 78
M_DEFINE_IRQ 79
M_DEFINE_IRQ 80
M_DEFINE_IRQ 81
M_DEFINE_IRQ 82
M_DEFINE_IRQ 83
M_DEFINE_IRQ 84
M_DEFINE_IRQ 85
M_DEFINE_IRQ 86
M_DEFINE_IRQ 87
M_DEFINE_IRQ 88
M_DEFINE_IRQ 89
M_DEFINE_IRQ 90
M_DEFINE_IRQ 91
M_DEFINE_IRQ 92
M_DEFINE_IRQ 93
M_DEFINE_IRQ 94
M_DEFINE_IRQ 95
M_DEFINE_IRQ 96
M_DEFINE_IRQ 97
M_DEFINE_IRQ 98
M_DEFINE_IRQ 99
M_DEFINE_IRQ 100
M_DEFINE_IRQ 101
M_DEFINE_IRQ 102
M_DEFINE_IRQ 103
M_DEFINE_IRQ 104
M_DEFINE_IRQ 105
M_DEFINE_IRQ 106
M_DEFINE_IRQ 107
M_DEFINE_IRQ 108
M_DEFINE_IRQ 109
M_DEFINE_IRQ 110
M_DEFINE_IRQ 111
M_DEFINE_IRQ 112
M_DEFINE_IRQ 113
M_DEFINE_IRQ 114
M_DEFINE_IRQ 115
M_DEFINE_IRQ 116
M_DEFINE_IRQ 117
M_DEFINE_IRQ 118
M_DEFINE_IRQ 119
M_DEFINE_IRQ 120
M_DEFINE_IRQ 121
M_DEFINE_IRQ 122
M_DEFINE_IRQ 123
M_DEFINE_IRQ 124
M_DEFINE_IRQ 125
M_DEFINE_IRQ 126
M_DEFINE_IRQ 127
M_DEFINE_IRQ 128
M_DEFINE_IRQ 129
M_DEFINE_IRQ 130
M_DEFINE_IRQ 131
M_DEFINE_IRQ 132
M_DEFINE_IRQ 133
M_DEFINE_IRQ 134
M_DEFINE_IRQ 135
M_DEFINE_IRQ 136
M_DEFINE_IRQ 137
M_DEFINE_IRQ 138
M_DEFINE_IRQ 139
M_DEFINE_IRQ 140
M_DEFINE_IRQ 141
M_DEFINE_IRQ 142
M_DEFINE_IRQ 143
M_DEFINE_IRQ 144
M_DEFINE_IRQ 145
M_DEFINE_IRQ 146
M_DEFINE_IRQ 147
M_DEFINE_IRQ 148
M_DEFINE_IRQ 149
M_DEFINE_IRQ 150
M_DEFINE_IRQ 151
M_DEFINE_IRQ 152
M_DEFINE_IRQ 153
M_DEFINE_IRQ 154
M_DEFINE_IRQ 155
M_DEFINE_IRQ 156
M_DEFINE_IRQ 157
M_DEFINE_IRQ 158
M_DEFINE_IRQ 159
M_DEFINE_IRQ 160
M_DEFINE_IRQ 161
M_DEFINE_IRQ 162
M_DEFINE_IRQ 163
M_DEFINE_IRQ 164
M_DEFINE_IRQ 165
M_DEFINE_IRQ 166
M_DEFINE_IRQ 167
M_DEFINE_IRQ 168
M_DEFINE_IRQ 169
M_DEFINE_IRQ 170
M_DEFINE_IRQ 171
M_DEFINE_IRQ 172
M_DEFINE_IRQ 173
M_DEFINE_IRQ 174
M_DEFINE_IRQ 175
M_DEFINE_IRQ 176
M_DEFINE_IRQ 177
M_DEFINE_IRQ 178
M_DEFINE_IRQ 179
M_DEFINE_IRQ 180
M_DEFINE_IRQ 181
M_DEFINE_IRQ 182
M_DEFINE_IRQ 183
M_DEFINE_IRQ 184
M_DEFINE_IRQ 185
M_DEFINE_IRQ 186
M_DEFINE_IRQ 187
M_DEFINE_IRQ 188
M_DEFINE_IRQ 189
M_DEFINE_IRQ 190
M_DEFINE_IRQ 191
M_DEFINE_IRQ 192
M_DEFINE_IRQ 193
M_DEFINE_IRQ 194
M_DEFINE_IRQ 195
M_DEFINE_IRQ 196
M_DEFINE_IRQ 197
M_DEFINE_IRQ 198
M_DEFINE_IRQ 199
M_DEFINE_IRQ 200
M_DEFINE_IRQ 201
M_DEFINE_IRQ 202
M_DEFINE_IRQ 203
M_DEFINE_IRQ 204
M_DEFINE_IRQ 205
M_DEFINE_IRQ 206
M_DEFINE_IRQ 207
M_DEFINE_IRQ 208
M_DEFINE_IRQ 209
M_DEFINE_IRQ 210
M_DEFINE_IRQ 211
M_DEFINE_IRQ 212
M_DEFINE_IRQ 213
M_DEFINE_IRQ 214
M_DEFINE_IRQ 215
M_DEFINE_IRQ 216
M_DEFINE_IRQ 217
M_DEFINE_IRQ 218
M_DEFINE_IRQ 219
M_DEFINE_IRQ 220
M_DEFINE_IRQ 221
M_DEFINE_IRQ 222
M_DEFINE_IRQ 223
M_DEFINE_IRQ 224
M_DEFINE_IRQ 225
M_DEFINE_IRQ 226
M_DEFINE_IRQ 227
M_DEFINE_IRQ 228
M_DEFINE_IRQ 229
M_DEFINE_IRQ 230
M_DEFINE_IRQ 231
M_DEFINE_IRQ 232
M_DEFINE_IRQ 233
M_DEFINE_IRQ 234
M_DEFINE_IRQ 235
M_DEFINE_IRQ 236
M_DEFINE_IRQ 237
M_DEFINE_IRQ 238
M_DEFINE_IRQ 239
M_DEFINE_IRQ 240
M_DEFINE_IRQ 241
M_DEFINE_IRQ 242
M_DEFINE_IRQ 243
M_DEFINE_IRQ 244
M_DEFINE_IRQ 245
M_DEFINE_IRQ 246
M_DEFINE_IRQ 247
M_DEFINE_IRQ 248
M_DEFINE_IRQ 249
M_DEFINE_IRQ 250
M_DEFINE_IRQ 251
M_DEFINE_IRQ 252
M_DEFINE_IRQ 253
M_DEFINE_IRQ 254
M_DEFINE_IRQ 255

isrCommon:
    ; Save all registers
    push eax
    push ebx
    push ecx
    push edx
    push esi
    push edi
    push ebp
    mov ax, ds
    push eax
    mov ax, es
    push eax
    mov ax, fs
    push eax
    mov ax, gs
    push eax

    mov ax, 0x10
    mov ds, ax
    mov es, ax
    mov fs, ax
    mov gs, ax
    mov ss, ax

    push esp

    cld ; SysV i386 calling convention: direction flag must be clear

    call irqHandler

    add esp, 4

    ; Restore registers
    pop eax
    mov gs, ax
    pop eax
    mov fs, ax
    pop eax
    mov es, ax
    pop eax
    mov ds, ax
    pop ebp
    pop edi
    pop esi
    pop edx
    pop ecx
    pop ebx
    pop eax

    add esp, 8 ; Pop interrupt number and error code

    iretd
