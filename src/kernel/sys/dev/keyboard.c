#include <stdbool.h>

#include "kernel/libk/stdio.h"
#include "kernel/libk/string.h"
#include "kernel/sys/dev/keyboard.h"
#include "kernel/sys/dev/tty.h"

void keyboard_driver_register(keyboard_driver_t *driver);
void keyboard_driver_input(keyboard_driver_t *driver, int keycode, bool pressed);

static bool keymod_lctrl = false;
static bool keymod_rctrl = false;
static bool keymod_lshift = false;
static bool keymod_rshift = false;
static bool keymod_lalt = false;
static bool keymod_ralt = false;
/*static const char *keymap_en[] = {
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "`", "~", "", "", "", "", "", "",
    "1", "!", "", "", "", "", "", "",
    "2", "@", "", "", "", "", "", "",
    "3", "#", "", "", "", "", "", "",
    "4", "$", "", "", "", "", "", "",
    "5", "%", "", "", "", "", "", "",
    "6", "^", "", "", "", "", "", "",
    "7", "&", "", "", "", "", "", "",
    "8", "*", "", "", "", "", "", "",
    "9", "(", "", "", "", "", "", "",
    "0", ")", "", "", "", "", "", "",
    "-", "_", "", "", "", "", "", "",
    "=", "+", "", "", "", "", "", "",
    "\b", "\b", "\b", "\b", "\b", "\b", "\b", "\b",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "/", "/", "", "", "", "", "", "",
    "*", "*", "", "", "", "", "", "",
    "-", "-", "", "", "", "", "", "",
    "\t", "\t", "", "", "", "", "", "",
    "q", "Q", "", "", "", "", "", "",
    "w", "W", "", "", "", "", "", "",
    "e", "E", "", "", "", "", "", "",
    "r", "R", "", "", "", "", "", "",
    "t", "T", "", "", "", "", "", "",
    "y", "Y", "", "", "", "", "", "",
    "u", "U", "", "", "", "", "", "",
    "i", "I", "", "", "", "", "", "",
    "o", "O", "", "", "", "", "", "",
    "p", "P", "", "", "", "", "", "",
    "[", "{", "", "", "", "", "", "",
    "]", "}", "", "", "", "", "", "",
    "\\", "|", "", "", "", "", "", "",
    "\n", "\n", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "7", "7", "", "", "", "", "", "",
    "8", "8", "", "", "", "", "", "",
    "9", "9", "", "", "", "", "", "",
    "+", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "a", "A", "", "", "", "", "", "",
    "s", "S", "", "", "", "", "", "",
    "d", "D", "", "", "", "", "", "",
    "f", "F", "", "", "", "", "", "",
    "g", "G", "", "", "", "", "", "",
    "h", "H", "", "", "", "", "", "",
    "j", "J", "", "", "", "", "", "",
    "k", "K", "", "", "", "", "", "",
    "l", "L", "", "", "", "", "", "",
    ";", ":", "", "", "", "", "", "",
    "'", "\"", "", "", "", "", "", "",
    "4", "4", "", "", "", "", "", "",
    "5", "5", "", "", "", "", "", "",
    "6", "6", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "z", "Z", "", "", "", "", "", "",
    "x", "X", "", "", "", "", "", "",
    "c", "C", "", "", "", "", "", "",
    "v", "V", "", "", "", "", "", "",
    "b", "B", "", "", "", "", "", "",
    "n", "N", "", "", "", "", "", "",
    "m", "M", "", "", "", "", "", "",
    ",", "<", "", "", "", "", "", "",
    ".", ">", "", "", "", "", "", "",
    "/", "?", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "1", "1", "", "", "", "", "", "",
    "2", "2", "", "", "", "", "", "",
    "3", "3", "", "", "", "", "", "",
    "\n", "\n", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    " ", " ", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "0", "0", "", "", "", "", "", "",
    ".", "", "", "", "", "", "", ""
};*/

static const char *keymap_fr[] = {
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "²", "~", "", "", "", "", "", "",
    "&", "1", "", "", "", "", "", "",
    "é", "2", "", "", "~", "", "", "",
    "\"", "3", "", "", "#", "", "", "",
    "'", "4", "", "", "{", "", "", "",
    "(", "5", "", "", "[", "", "", "",
    "-", "6", "", "", "|", "", "", "",
    "è", "7", "", "", "`", "", "", "",
    "_", "8", "", "", "\\", "", "", "",
    "ç", "9", "", "", "^", "", "", "",
    "à", "0", "", "", "@", "", "", "",
    ")", "°", "", "", "]", "", "", "",
    "=", "+", "", "", "}", "", "", "",
    "\b", "\b", "\b", "\b", "\b", "\b", "\b", "\b",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "/", "/", "", "", "", "", "", "",
    "*", "*", "", "", "", "", "", "",
    "-", "-", "", "", "", "", "", "",
    "\t", "\t", "", "", "", "", "", "",
    "a", "A", "", "", "", "", "", "",
    "z", "Z", "", "", "", "", "", "",
    "e", "E", "", "", "", "", "", "",
    "r", "R", "", "", "", "", "", "",
    "t", "T", "", "", "", "", "", "",
    "y", "Y", "", "", "", "", "", "",
    "u", "U", "", "", "", "", "", "",
    "i", "I", "", "", "", "", "", "",
    "o", "O", "", "", "", "", "", "",
    "p", "P", "", "", "", "", "", "",
    "^", "¨", "", "", "", "", "", "",
    "$", "£", "", "", "¤", "", "", "",
    "*", "µ", "", "", "", "", "", "",
    "\n", "\n", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "7", "7", "", "", "", "", "", "",
    "8", "8", "", "", "", "", "", "",
    "9", "9", "", "", "", "", "", "",
    "+", "+", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "q", "Q", "", "", "", "", "", "",
    "s", "S", "", "", "", "", "", "",
    "d", "D", "", "", "", "", "", "",
    "f", "F", "", "", "", "", "", "",
    "g", "G", "", "", "", "", "", "",
    "h", "H", "", "", "", "", "", "",
    "j", "J", "", "", "", "", "", "",
    "k", "K", "", "", "", "", "", "",
    "l", "L", "", "", "", "", "", "",
    "m", "M", "", "", "", "", "", "",
    "ù", "%", "", "", "", "", "", "",
    "4", "4", "", "", "", "", "", "",
    "5", "5", "", "", "", "", "", "",
    "6", "6", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "w", "W", "", "", "", "", "", "",
    "x", "X", "", "", "", "", "", "",
    "c", "C", "", "", "", "", "", "",
    "v", "V", "", "", "", "", "", "",
    "b", "B", "", "", "", "", "", "",
    "n", "N", "", "", "", "", "", "",
    ",", "?", "", "", "", "", "", "",
    ";", ".", "", "", "", "", "", "",
    ":", "/", "", "", "", "", "", "",
    "!", "§", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "1", "1", "", "", "", "", "", "",
    "2", "2", "", "", "", "", "", "",
    "3", "3", "", "", "", "", "", "",
    "\n", "\n", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    " ", " ", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "", "", "", "", "", "", "", "",
    "0", "0", "", "", "", "", "", "",
    ".", "", "", "", "", "", "", ""
};

static const char **keymap = keymap_fr;

void keyboard_driver_register(keyboard_driver_t *driver) {
    (void)driver;
}

void keyboard_driver_input(keyboard_driver_t *driver, int keycode, bool pressed) {
    (void)driver;

    switch(keycode) {
        case KEYCODE_LCTRL: keymod_lctrl = pressed; return;
        case KEYCODE_RCTRL: keymod_rctrl = pressed; return;
        case KEYCODE_LSHIFT: keymod_lshift = pressed; return;
        case KEYCODE_RSHIFT: keymod_rshift = pressed; return;
        case KEYCODE_LALT: keymod_lalt = pressed; return;
        case KEYCODE_RALT: keymod_ralt = pressed; return;
    }

    if(!pressed) {
        return;
    }

    bool keymod_ctrl = keymod_lctrl | keymod_rctrl;
    bool keymod_shift = keymod_lshift | keymod_rshift;
    int keymod = (keymod_shift ? 1 : 0) | (keymod_ctrl ? 2 : 0) | (keymod_ralt ? 4 : 0);
    
    if(keycode < 106) {
        tty_driver_input(tty_getDefault(), keymap[(keycode << 3) | keymod], strlen(keymap[(keycode << 3) | keymod]));
    }
}
